AWSTemplateFormatVersion: 2010-09-09
Description: Deploy CloudFormation

Parameters:
  userPoolName:
    Type: String

  snsRoleName:
    Type: String

  snsPolicyName:
    Type: String

  passwordPolicyMinLength:
    Type: String

  emailVerificationSubject:
    Type: String

  emailVerificationMessage:
    Type: String

  smsAuthenticationMessage:
    Type: String

  smsVerificationMessage:
    Type: String

  autoVerifiedAttributes:
    Type: CommaDelimitedList

  usernameAttributes:
    Type: CommaDelimitedList

  mfaConfiguration:
    Type: String

  userpoolClientGenerateSecret:
    Type: String

  userpoolClientRefreshTokenValidity:
    Type: String

Resources:
  SNSRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref snsRoleName
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: ""
            Effect: "Allow"
            Principal:
              Service: "cognito-idp.amazonaws.com"
            Action:
              - "sts:AssumeRole"

      Policies:
        - PolicyName: !Ref snsPolicyName
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "sns:Publish"
                Resource: "*"

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Ref userPoolName
      UsernameConfiguration:
        CaseSensitive: false
      Schema:
        - Name: email
          Required: true
          Mutable: true
      AutoVerifiedAttributes: !Ref autoVerifiedAttributes
      EmailVerificationMessage: !Ref emailVerificationMessage
      EmailVerificationSubject: !Ref emailVerificationSubject
      Policies:
        PasswordPolicy:
          MinimumLength: !Ref passwordPolicyMinLength
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false
          RequireUppercase: false
      UsernameAttributes: !Ref usernameAttributes
      MfaConfiguration: !Ref mfaConfiguration
      SmsVerificationMessage: !Ref smsVerificationMessage
      SmsAuthenticationMessage: !Ref smsAuthenticationMessage
      SmsConfiguration:
        SnsCallerArn: !GetAtt SNSRole.Arn

  UserPoolClientWeb:
    Type: "AWS::Cognito::UserPoolClient"
    Properties:
      ClientName: !Join ["", [!Ref userPoolName, "-", "clientweb"]]
      RefreshTokenValidity: !Ref userpoolClientRefreshTokenValidity
      UserPoolId: !Ref UserPool
    DependsOn: UserPool

  UserPoolClient:
    Type: "AWS::Cognito::UserPoolClient"
    Properties:
      ClientName: !Join ["", [!Ref userPoolName, "-", "client"]]
      GenerateSecret: !Ref userpoolClientGenerateSecret
      RefreshTokenValidity: !Ref userpoolClientRefreshTokenValidity
      UserPoolId: !Ref UserPool
    DependsOn: UserPool

Outputs:
  UserPoolId:
    Value: !Ref "UserPool"
    Description: Id for the user pool
  UserPoolName:
    Value: !Ref userPoolName
  AppClientIDWeb:
    Value: !Ref "UserPoolClientWeb"
    Description: The user pool app client id for web
  AppClientID:
    Value: !Ref "UserPoolClient"
    Description: The user pool app client id
